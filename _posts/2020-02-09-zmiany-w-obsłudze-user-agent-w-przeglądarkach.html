---
layout: post
title: Zmiany w obsłudze User-Agent w przeglądarkach opartych na Chromium
date: '2020-02-09T17:35:03+01:00'
tags:
- chromium
- edge
- o365
- officeonline
- wiaevaluationmethod
- wiacapabilitydetection
- wiauseragentdetection
- useragent
- ua
- firefox
tumblr_url: https://blog.pfe.academy/post/190736637203/zmiany-w-obs%C5%82udze-user-agent-w-przegl%C4%85darkach
---
<p>Zgodnie z publikacjami na blogu projektu Chromium, w<a href="https://blog.chromium.org/2019/08/potential-uses-for-privacy-sandbox.html"> sierpniu 2019 r.</a> w ramach <a href="https://www.chromium.org/Home/chromium-privacy/privacy-sandbox">Privacy Sandbox</a> Project, został opracowany mechanizm Client Hints. Pod koniec ubiegłego miesiąca ponownie zrobiło się o nim głośno, a to za sprawą publikacji Mike Westa (Chrome Security Team) i Yoav Weissa (Chrome Developer Relations Team) na <a href="https://wicg.github.io/ua-client-hints/">W3C Community Group</a> i zapowiedzi jego implementacji przed końcem roku.</p><p><a href="https://imgur.com/hirPfIt"></a></p><figure data-orig-width="1242" data-orig-height="874" data-orig-src="https://i.imgur.com/hirPfIt.png" class="tmblr-full"><img src="https://64.media.tumblr.com/289eb2c4f1a111a7fe9a36e92506c8b2/d708162f5b8b05e3-6c/s540x810/b9d531a94bfef7b24dcbbc14609f83a3deadf3fe.png" alt="image" data-orig-width="1242" data-orig-height="874" data-orig-src="https://i.imgur.com/hirPfIt.png"/></figure><p>Zasięg zmian jest bardzo szeroki, bo obejmuje wszystkie zależne od Chromium przeglądarki, co sumarycznie przekłada się na ponad 75% użytkowników. </p><!-- more --><p><a href="https://imgur.com/Ok1PHfN"></a></p><figure data-orig-width="1224" data-orig-height="173" data-orig-src="https://i.imgur.com/Ok1PHfN.png" class="tmblr-full"><img src="https://64.media.tumblr.com/d0b626aac5381163f1035c8d08f63468/d708162f5b8b05e3-29/s540x810/07ba6e6e9ed987ea198bc6cc1c731a0bafd27f82.png" alt="image" data-orig-width="1224" data-orig-height="173" data-orig-src="https://i.imgur.com/Ok1PHfN.png"/></figure><p>Nowy mechanizm ma na celu zapewnienie deweloperom możliwości negocjowania treści na podstawie identyfikatora User-Agent klienta, bez odsłaniania zbędnych informacji, które służą tworzeniu „odcisku palca” użytkowników i ograniczają prywatność.  </p><p><a href="https://imgur.com/XWAg4o2"></a></p><figure data-orig-width="965" data-orig-height="741" data-orig-src="https://i.imgur.com/XWAg4o2.png" class="tmblr-full"><img src="https://64.media.tumblr.com/a0ffa27b245adf124cb47e7ec45ec3f7/d708162f5b8b05e3-e8/s540x810/2c6025975b1f14715f4f81bd31c94915d052ed43.png" alt="image" data-orig-width="965" data-orig-height="741" data-orig-src="https://i.imgur.com/XWAg4o2.png"/></figure><h2>Co to w ogóle jest User-Agent?</h2><p>Zanim wejdziemy w dalsze szczegóły, przypomnijmy, co to jest User-Agent (UA)? UA jest ciągiem znaków (tekst), jaki przeglądarki internetowe oraz inne oprogramowanie klienckie przesyła serwerowi w czasie inicjalnego połączenia z witryną lub aplikacją webową. User-Agent to swego rodzaju wizytówka, zawiera informacje o typie przeglądarki, silniku renderującym oraz systemie operacyjnym, przykładowo:</p><p><a href="https://imgur.com/pqfsQkz"></a></p><figure data-orig-width="799" data-orig-height="692" data-orig-src="https://i.imgur.com/pqfsQkz.png" class="tmblr-full"><img src="https://64.media.tumblr.com/7d005edb775077228b3d49bbd7f331ed/d708162f5b8b05e3-88/s540x810/56dce21877aea969fb99898e3be54fb4f0f42b56.png" alt="image" data-orig-width="799" data-orig-height="692" data-orig-src="https://i.imgur.com/pqfsQkz.png"/></figure><p>Powyższy zrzut ekranu wizualizuje identyfikację mojej przeglądarki za pomocą useraget v2.2.1 (na <a href="https://www.whatsmyua.info/">whatsmyua.info</a> można zobaczyć wyniki <a href="https://github.com/3rd-Eden/useragent">useragent</a>, <a href="https://github.com/faisalman/ua-parser-js">ua-parser-js</a> oraz <a href="https://github.com/bestiejs/platform.js/">platform.js</a>). Rzućmy okien na wyniki z komunikatora Teams. </p><p><a href="https://imgur.com/HNleya3"></a></p><figure data-orig-width="794" data-orig-height="691" data-orig-src="https://i.imgur.com/HNleya3.png" class="tmblr-full"><img src="https://64.media.tumblr.com/7a338117e618ef8cb882f29a7c3b7544/d708162f5b8b05e3-1d/s540x810/e8198565ef36007b927a336efccdc74552d1fd51.png" alt="image" data-orig-width="794" data-orig-height="691" data-orig-src="https://i.imgur.com/HNleya3.png"/></figure><p>Powyższa funkcjonalność może być użyteczna, gdy serwer oczekuje wykonania czynności, którą nie każde oprogramowanie klienckie potrafi zrealizować, dając tym samym możliwość obsługi wyjątków. Takimi funkcjonalnościami może być uwierzytelnianie zintegrowane z Windows, obsługa akceleracji 3D, obracanie ekranu lub odtwarzanie określonych formatów wideo. Wydaje się, że to dość użyteczne, prawda? </p><h2>Diabeł tkwi w szczegółach</h2><p>Niestety (nader często) UA jest wykorzystywany do innych niż wskazane wcześniej cele, np. bardziej precyzyjnego śledzenia użytkowników lub blokowania konkurencji. Przed pierwszy bronią się użytkownicy, za pomocą opcji wbudowanych lub dostarczanych przez rozszerzenia, przed drugim „ograniczani” dostawcy oprogramowania i usług.</p><p>

Vivaldi podobnie jako nowy Edge opiera się na kodzie Chromium. Jednak Google Search oraz Docs, Netflix Player, Facebook WhatsApp, a nawet Microsoft Teams, blokują możliwość korzystania lub robią to z umyślnymi błędami (które znikają, gdy tylko UA przeglądarki zostanie „sfałszowane”). Dlatego <a href="https://vivaldi.com/blog/user-agent-changes/">od grudnia 2019 r. Vivaldi maskuje swój UA</a>, z wyjątkiem kilku witryn, z którymi otwarcie współpracuje (<a href="https://duckduckgo.com/">duckduckgo.com</a>, <a href="https://ecosia.org/">ecosia.org</a>, <a href="https://qwant.com/">qwant.com</a> i <a href="https://startpage.com/">startpage.com</a>).  <a href="https://www.onmsft.com/news/google-has-apparently-blocked-its-stadia-cloud-gaming-service-on-the-chromium-based-microsoft-edge">Google blokuje używanie rozwojowych wersji Edge w Stadia Cloud Gaming Service</a> oraz kilku innych usługach. </p><p>Powiecie (zresztą słusznie, że to) dość skrajne przypadki. Jednak, gdy się przyjrzeć zachowaniu przeglądarek, okaże się, że wszyscy „kłamią” na swój temat, udając, że są wszystkimi. Im bardziej tak się dzieje, tym mniej użyteczne staje się wykrywanie User-Agent. </p><h2>Jaki jest plan Google?</h2><p>Google planuje zaprzestać aktualizowania komponentu UA w Chrome nowymi ciągami (tekstem UA, który Chrome udostępnia stronom internetowym).</p><p>Plan długoterminowy polega na ujednoliceniu wszystkich ciągów znaków UA Chrome w ogólne wartości, które nie ujawniają zbyt dużej ilości informacji o użytkowniku. Oznacza to, że nowe wersje przeglądarki Chrome na nowe platformy, takie jak nowe modele smartfonów lub nowe wersje systemu operacyjnego, będą używać ogólnego identyfikatora UA, a nie takiego, który jest dostosowany do konkretnej platformy.</p><p>Na przykład w przyszłości witryna internetowa nie będzie w stanie stwierdzić, czy użytkownik korzystający z Chrome używa Chrome w systemie Windows 7 lub Windows 11, czy też użytkownik mobilny Chrome korzysta z telefonu Samsung Galaxy, iPhone czy Pixel.</p><p>Strony internetowe będą mogły stwierdzić, że użytkownik korzysta z Chrome na komputerze lub urządzeniu mobilnym i nic poza tym.</p><p>Ze względu wsteczną kompatybilność User-Agent 

w Chrome będzie nadal działać, więc nie uszkodzi to mechanizmów i skryptów w dotychczasowych witrynach i aplikacjach webowych. Z czasem jego znaczenie będzie jednak maleć. </p><p>Oto aktualny plan Google dotyczący ograniczenia obsługi User-Agent:</p><ul><li>Chrome 81 (połowa marca 2020 r.) - Google planuje wyświetlać ostrzeżenia w konsoli Chrome dla stron internetowych, które czytają ciąg znaków UA, aby programiści mogli dostosować kod swojej witryny.</li><li>Chrome 83 (początek czerwca 2020 r.) - Google zamrozi wersję przeglądarki Chrome w identyfikatorze UA i ujednolici wersje systemu operacyjnego.</li><li>Chrome 85 (połowa września 2020 r.) - Google ujednolici identyfikator UA dla desktopowych wersji przeglądarek. Podobne ujednolicenie spotka też wersje na systemy mobilne.</li></ul><p>Poniżej przedstawiono przykładowy User-Agent dla mobilnej wersji Chrome  po zamrożeniu modyfikacji UA:</p><pre><code>Mozilla/5.0 (Linux; Android 9; Unspecified Device) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/71.1.2222.33 Mobile Safari/537.36</code></pre><p>Tak z kolei będzie się prezentować Chrome w wersji na desktopy po zamrożeniu UA:</p><pre><code>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.1.2222.33 Safari/537.36</code></pre><p>Gdy użytkownik otworzy witrynę lub aplikację webową, jego żądanie będzie zawierać zamrożony identyfikator UA, a także specjalny nagłówek „Sec-UA”, który przekaże podstawowe informacje o kliencie, jak pokazano poniżej.</p><pre><code>Sec-CH-UA: "Examplary Browser 73"</code></pre><p>Jeśli serwer potrzebować będzie więcej informacji, poprosi o to w nagłówku odpowiedzi „opt-in”. Wówczas, zostanie poproszony o dostarczenie dodatkowych informacji, np. takich jak wersja pomocnicza i system operacyjny. Można to zrobić za pomocą następującego żądania w nagłówku HTTP:<br/></p><pre><code>Accept-CH: UA, Platform</code></pre><p>Wówczas klienci, którzy będą kompatybilni i których ustawienia na to pozwolą, prześlą następującą odpowiedź na takie żądanie:</p><pre><code>Sec-CH-UA: "Examplary Browser 73.3R8.2H.1"
Sec-CH-Platform: "Windows 10"</code></pre><p>Decyzja o wysłaniu informacji będzie należała do klienta, zatem indywidualni użytkownicy oraz organizacje będą mogły stosować własne reguły odpowiadania, udzielając dodatkowych informacji witrynom i aplikacjom z zaufanych adresów.<br/></p><p>Aby skorzystać z Client Hints, witryna lub aplikacja webowa musi spełnić następujące wymagania:</p><ul><li>Żądania opt-in serwera muszą być kierowane z adresu głównego poziomu witryny (top-level navigation request) przez bezpieczne połączenie (TLS).</li><li>Odpowiedzi są dostarczane tylko w odpowiedzi na oryginalne żądanie (<a href="https://blog.pfe.academy/post/190462924468/o-co-chodzi-w-samesite-w-ciasteczkach">inaczej niż w przypadku ciasteczek</a>) w bezpiecznym połączeniu.</li><li>Jeśli odpowiedzi otrzymane przez witrynę lub aplikację webową otwartą przez użytkownika (własne, first-party) mają być dostarczane do określonych serwerów innych podmiotów (third-party hosts), należy je jawnie wydelegować.</li><li>Odpowiedzi są przekazywane z prefiksem <code>Sec-</code>, aby zapewnić większe bezpieczeństwo oraz uniknąć błędów z obsługą po stornie niekomatybilnych serwerów.</li></ul><p>Uwzględniając powyższe, Google chce usunąć dostęp do właściwości navigator.userAgent 

za pomocą 

JavaScript w Chrome 81. </p><h2>Co z implementacją w innych przeglądarkach?</h2><p>

Apple (<a href="https://twitter.com/rmondello/status/943545865204989953">Safari</a>), Microsoft (<a href="https://twitter.com/_scottlow/status/1206831008261132289">Edge</a>) oraz Mozilla (<a href="https://github.com/mozilla/standards-positions/issues/202#issuecomment-558294095">Firefox</a>) w mniej lub bardziej oficjalny sposób potwierdził, że zaimplementują proponowany przez Google mechanizm wycofania obsługi User-Agent na rzecz Client Hints. Na szczegóły przyjdzie nam jeszcze poczekać. </p><p>W <a href="https://developer.microsoft.com/en-us/microsoft-edge/status/">mapie rozwoju Edge</a> nie ma jeszcze informacji o nowym mechanizmie. </p><p><a href="https://imgur.com/seIVTgo"></a></p><figure data-orig-width="1494" data-orig-height="1081" data-orig-src="https://i.imgur.com/seIVTgo.png" class="tmblr-full"><img src="https://64.media.tumblr.com/e7f47595b4f1ca98199f911d42cc890b/d708162f5b8b05e3-92/s540x810/e6d7c80e567966a44971ec50389a7aec33835713.png" alt="image" data-orig-width="1494" data-orig-height="1081" data-orig-src="https://i.imgur.com/seIVTgo.png"/></figure><p>Nie ma ich też w artykule <a href="https://docs.microsoft.com/en-us/microsoft-edge/web-platform/site-impacting-changes">Site compatibility-impacting changes coming to Microsoft Edge</a>, gdzie w pierwszej kolejności informujemy o dużych zmianach, które wpływają na kompatybilność przeglądarki.
</p><p><a href="https://imgur.com/w9W5Wcp"></a></p><figure data-orig-width="978" data-orig-height="796" data-orig-src="https://i.imgur.com/w9W5Wcp.png" class="tmblr-full"><img src="https://64.media.tumblr.com/1d18ae170073db97df2ca4aad7884df4/d708162f5b8b05e3-e7/s540x810/29509784f877420e7712a369c97a250b482ebbab.png" alt="image" data-orig-width="978" data-orig-height="796" data-orig-src="https://i.imgur.com/w9W5Wcp.png"/></figure><h2>Jaki to ma wpływ na rozwiązania Microsoftu? </h2><p>Nie ulega wątpliwości, że zmiany te będą miały wpływ na witryny oraz aplikacje webowe uruchomione na ISS w Windows Server, a także Azure Web App oraz Azure Web Sites.</p><p>Zmiany dotkną także platformy uwierzytelniania w chmurze (Microsoft Online Services Sign-In, Microsoft Office 365 Identity Platform) oraz usług federacyjnych Active Directory Federation Services.</p><p>W tych drugich, w Windows Server 2016 i nowszych, istnieją dwa mechanizmy wykrywania zgodności klientów z mechanizmami logowania zintegrowanego z Windows. Aby się o tym przekonać, przyjrzyjmy się właściwości WiaEvaluationMethod zwracanej przez polecenie Get-AdfsProperties.</p><p><a href="https://imgur.com/ZlriRmW"></a></p><figure data-orig-width="870" data-orig-height="169" data-orig-src="https://i.imgur.com/ZlriRmW.png" class="tmblr-full"><img src="https://64.media.tumblr.com/7a864b5a0a6c48e5eb3ffd5a3562f7e5/d708162f5b8b05e3-2f/s540x810/f96e76fd99be781aa747562f17f26e506203ecd1.png" alt="image" data-orig-width="870" data-orig-height="169" data-orig-src="https://i.imgur.com/ZlriRmW.png"/></figure><p>Ustawienie WiaEvaluationMethod może przyjąć dwie wartości: WiaCapabilityDetection oraz WiaUserAgentDetection. Domyślne ADFS posługuje się drugą wartością, co powoduje, że oferuje mechanizmy logowania zintegrowanego klientom (Kerberos, 

Single Sign-On (SSO)), których User-Agent znajduje się na liście kompatybilnych.</p><p><a href="https://imgur.com/P4mbMWV"></a></p><figure data-orig-width="873" data-orig-height="223" data-orig-src="https://i.imgur.com/P4mbMWV.png" class="tmblr-full"><img src="https://64.media.tumblr.com/cfd37a2da3b01b15518c3098b1d3719f/d708162f5b8b05e3-09/s540x810/5474aa09551324723adc076db9e885d00aabfdd9.png" alt="image" data-orig-width="873" data-orig-height="223" data-orig-src="https://i.imgur.com/P4mbMWV.png"/></figure><p>Oznacza to, że najpóźniej we wrześniu należy się spodziewać poprawki, która dostarczy obsługi żądań opcjonalnych przez serwer usług federacyjnych i tym sposobem pozyskiwane będą wymagane elementy identyfikujące klienta za pomocą Client Hints.</p><p>Z drugiej strony, może to być także dodatkowa motywacja dla grupy produktowej, aby wznowiono prace nad mechanizmami WiaCapabilityDetection oraz dostarczono ich publicznej dokumentacji. </p>
